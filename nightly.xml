<?xml version="1.0"?>
<project name="nant" default="nightly-self">
    <!-- set project.version to current date/time in yyyyMMdd format -->
    <tstamp property="project.version" pattern="yyyyMMdd" />
    <property name="sf.net.ssh.server" value="shell1.sf.net" />
    <property name="sf.net.web.path" value="/home/groups/n/na/nantcontrib/htdocs" />
    <!-- retrieve system information and environment variables -->
    <sysinfo />
    <!-- setup property that holds partial path to be used by scp -->
    <property name="serverpart" value="${sys.env.USERNAME}@${sf.net.ssh.server}:${sf.net.web.path}" />
    <!-- all our builds are release builds -->
    <property name="debug" value="false" readonly="true" />
    <include buildfile="nantcontrib.build" />
    <target name="nightly">
        <property name="NAntReleaseEXE" value="${nant.dir}/bin/nant.exe" />
        <available property="NAntReleaseEXEExists" resource="${NAntReleaseEXE}" type="File" />
        <exec program="${NAntReleaseEXE}">
            <arg value="-buildfile:nightly.xml" />
            <arg value="-D:nant.dir=${nant.dir}" />
        </exec>
    </target>
    <target name="nightly-self" depends="nightly-tasks, nightly-web" />
    <target name="nightly-tasks" depends="build doc" description="Updates SF.Net site with new release build of tasks">
        <property name="project.zip-path" value="${nant.project.basedir}/build/${project.name}.Tasks-${project.version}.zip" />
        <!-- copy project files -->
        <copy todir="${build.dir}">
            <fileset>
                <includes name="src/**" />
                <includes name="*" />
            </fileset>
        </copy>
        <zip zipfile="${project.zip-path}">
            <fileset basedir="${build.dir}">
                <includes name="**/*" />
                
                <excludes name="**/cache/**" />
                <excludes name="**/_*/**" />
                <excludes name="**/Schemas/**" />
                <excludes name="**/doc/MSDN/**" />
            </fileset>
        </zip>
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=755 --parents ${sf.net.web.path}/builds" />
        </exec>
        <regex input="${project.zip-path}" pattern="^(?'execpath'.*(\\|/)|(/|\\))(?'execfilename'.*)$" />
        <!-- copy the build to sourceforge -->
        <exec workingdir="${execpath}" program="scp">
            <arg value="${execfilename}" />
            <arg value="${serverpart}/builds/${execfilename}" />
        </exec>
        <echo message="Copied nightly build over to SF.Net" />
        <!-- make sure permissions are set right -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod 755 ${sf.net.web.path}/builds/${execfilename}" />
        </exec>
    </target>
    <target name="nightly-msi" depends="msi" />
    <target name="nightly-web" depends="doc">
        <!-- make sure the directory tree exists -->
        <exec program="ssh">
            <arg value="${sf.net.ssh.server}" />
            <arg value="mkdir --mode=755 --parents ${sf.net.web.path}/doc" />
        </exec>
        <!-- copy the help to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc/help" program="scp">
            <arg value="-r" />
            <arg value="-C" />
            <arg value="*" />
            <arg value="${serverpart}/doc" />
        </exec>
        <!-- copy stylesheet for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="style.css" />
            <arg value="${serverpart}/doc" />
        </exec>
        <!-- copy arrow.gif for website to sourceforge (using compression) -->
        <exec workingdir="${build.dir}/doc" program="scp">
            <arg value="-C" />
            <arg value="arrow.gif" />
            <arg value="${serverpart}/doc" />
        </exec>
        <!-- make sure permissions are set right -->
        <exec program="ssh" failonerror="false">
            <arg value="${sf.net.ssh.server}" />
            <arg value="chmod -R 755 ${sf.net.web.path}/*" />
        </exec>
    </target>
</project>
